<script>
        console.log('üöÄ INIZIO CARICAMENTO SISTEMA');
        console.log('üìç Step 1: Script principale avviato');
        
        // Test se Firebase √® disponibile
        window.addEventListener('load', function() {
            console.log('üìç Step 2: Pagina caricata completamente');
            
            setTimeout(function() {
                console.log('üìç Step 3: Verifica Firebase...');
                
                if (typeof firebase !== 'undefined') {
                    console.log('‚úÖ Firebase SDK TROVATO');
                } else {
                    console.error('‚ùå Firebase SDK NON CARICATO!');
                    console.error('üîß Questo √® il problema!');
                    
                    alert('‚ö†Ô∏è PROBLEMA TROVATO!\n\n' +
                          'Gli script Firebase non si stanno caricando.\n\n' +
                          'Possibili cause:\n' +
                          '1. Firewall/Antivirus blocca Firebase\n' +
                          '2. Adblocker attivo\n' +
                          '3. Problema rete\n\n' +
                          'SOLUZIONE:\n' +
                          '- Disattiva Adblocker\n' +
                          '- Ricarica la pagina\n' +
                          '- Prova in modalit√† incognito');
                }
                
                if (typeof firebase === 'undefined') {
                    // Fallback: usa solo localStorage
                    console.log('üì± Attivazione modalit√† SOLO localStorage');
                    window.firebaseConnected = false;
                    window.firebaseDatabase = null;
                    
                    if (window.updateStatus) {
                        window.updateStatus('üì± Modalit√† locale - Firebase non disponibile');
                    }
                }
            }, 2000);
        });
        
        // ‚ö° DEFINISCI updateStatus GLOBALMENTE PRIMA DI TUTTO
        function updateStatus(message) {
            console.log('üì¢', message);
            const statusBar = document.getElementById('statusBar');
            if (statusBar) {
                statusBar.innerHTML = message;
                if (message.includes('üî•') || message.includes('‚úÖ')) {
                    statusBar.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                } else if (message.includes('‚ö†Ô∏è')) {
                    statusBar.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                } else {
                    statusBar.style.background = 'linear-gradient(135deg, #6366f1, #4f46e5)';
                }
            }
        }
        
        // Rendi disponibile subito
        window.updateStatus = updateStatus;
        
        console.log('üöÄ JavaScript principale caricato');
        
        // üéØ VARIABILI GLOBALI
        let currentTournament = '';
        let players = [];
        let matches = {};
        let playerStats = {};
        let currentMatchKey = '';
        let realtimeListeners = [];

        // üìä GIOCATORI PREDEFINITI
        const defaultPlayers = [
            'Alessandro Rossi', 'Marco Bianchi', 'Giuseppe Verdi', 'Francesco Romano',
            'Andrea Colombo', 'Matteo Ferrari', 'Lorenzo Marino', 'Davide Ricci',
            'Simone Greco', 'Federico Costa', 'Gabriele Conti', 'Riccardo Villa'
        ];

        // üöÄ INIZIALIZZAZIONE APP - VERSIONE CORRETTA
        function initApp() {
            console.log('üéæ App inizializzata!');
            updateStatus('‚úÖ Sistema pronto - Crea o unisciti a un torneo!');
            
            // Auto-focus su input torneo
            setTimeout(() => {
                const input = document.getElementById('tournamentName');
                if (input) {
                    input.focus();
                    input.select();
                    console.log('‚úÖ Input pronto');
                }
            }, 200);
            
            console.log('‚úÖ Sistema completamente funzionante!');
        }
        
        // Rendi initApp disponibile globalmente
        window.initApp = initApp;

        // üì± DATABASE HELPER FUNCTIONS - FIREBASE REALE
        async function saveToDatabase(path, data) {
            // Prova Firebase
            if (window.firebaseConnected && window.firebaseDatabase) {
                try {
                    const dbRef = window.firebaseRef(window.firebaseDatabase, path);
                    await window.firebaseSet(dbRef, data);
                    console.log('üî• Salvato su Firebase:', path);
                    updateStatus('üî• Salvato nel cloud - Visibile a tutti!');
                    
                    setTimeout(() => {
                        updateStatus('üî• Firebase connesso - Database cloud attivo!');
                    }, 2000);
                    
                    // Backup locale
                    try {
                        const key = 'tennis_' + path.replace(/\//g, '_');
                        localStorage.setItem(key, JSON.stringify(data));
                    } catch (e) {}
                    
                    return true;
                } catch (error) {
                    console.error('‚ùå Errore Firebase:', error);
                    updateStatus('‚ö†Ô∏è Errore salvataggio cloud - Verifica connessione');
                }
            }
            
            // Fallback localStorage
            try {
                const key = 'tennis_' + path.replace(/\//g, '_');
                localStorage.setItem(key, JSON.stringify(data));
                console.log('üíæ Salvato in locale:', key);
                updateStatus('üíæ Salvato localmente (Firebase offline)');
                return true;
            } catch (e) {
                console.error('‚ùå Errore salvataggio:', e);
                updateStatus('‚ùå Errore salvataggio');
                return false;
            }
        }

        async function loadFromDatabase(path) {
            // Prova Firebase
            if (window.firebaseConnected && window.firebaseDatabase) {
                try {
                    const dbRef = window.firebaseRef(window.firebaseDatabase, path);
                    const snapshot = await window.firebaseGet(dbRef);
                    const firebaseData = snapshot.val();
                    
                    if (firebaseData) {
                        console.log('üî• Caricato da Firebase:', path);
                        
                        // Backup locale
                        try {
                            const key = 'tennis_' + path.replace(/\//g, '_');
                            localStorage.setItem(key, JSON.stringify(firebaseData));
                        } catch (e) {}
                        
                        return firebaseData;
                    }
                } catch (error) {
                    console.error('‚ùå Errore lettura Firebase:', error);
                }
            }
            
            // Fallback localStorage
            try {
                const key = 'tennis_' + path.replace(/\//g, '_');
                const stored = localStorage.getItem(key);
                if (stored) {
                    console.log('üíæ Caricato da localStorage:', key);
                    return JSON.parse(stored);
                }
            } catch (e) {
                console.error('‚ùå Errore lettura localStorage:', e);
            }
            
            return null;
        }

        // üèÜ CREA TORNEO
        async function createTournament() {
            const tournamentName = document.getElementById('tournamentName').value.trim();
            
            if (!tournamentName) {
                alert('‚ö†Ô∏è Inserisci un nome per il torneo');
                return;
            }

            try {
                updateStatus('üèóÔ∏è Creazione torneo...');
                currentTournament = tournamentName;
                
                // Inizializza dati del torneo
                players = [...defaultPlayers];
                initializePlayerStats();
                initializeMatches();
                
                // Salva nel database
                const success = await saveToDatabase(`tournaments/${tournamentName}`, {
                    players: players,
                    matches: matches,
                    playerStats: playerStats,
                    created: new Date().toISOString(),
                    lastUpdate: new Date().toISOString()
                });
                
                if (success) {
                    showTournament();
                    setupRealtimeSync();
                    updateStatus(`üèÜ Torneo "${tournamentName}" creato!`);
                } else {
                    updateStatus('‚ùå Errore creazione torneo');
                }
                
            } catch (error) {
                console.error('‚ùå Errore:', error);
                updateStatus('‚ùå Errore durante la creazione');
            }
        }

        // üë• UNISCITI AL TORNEO
        async function joinTournament() {
            const tournamentName = document.getElementById('tournamentName').value.trim();
            
            if (!tournamentName) {
                alert('‚ö†Ô∏è Inserisci il nome del torneo');
                return;
            }

            try {
                updateStatus('üîç Ricerca torneo...');
                
                const tournamentData = await loadFromDatabase(`tournaments/${tournamentName}`);
                
                if (!tournamentData) {
                    alert(`‚ùå Torneo "${tournamentName}" non trovato.\n\nClicca "Crea Torneo" per crearlo.`);
                    updateStatus('‚ùå Torneo non trovato');
                    return;
                }
                
                // Carica dati esistenti
                currentTournament = tournamentName;
                players = tournamentData.players || [...defaultPlayers];
                matches = tournamentData.matches || {};
                playerStats = tournamentData.playerStats || {};
                
                // Inizializza se necessario
                if (Object.keys(playerStats).length === 0) {
                    initializePlayerStats();
                }
                if (Object.keys(matches).length === 0) {
                    initializeMatches();
                }
                
                showTournament();
                setupRealtimeSync();
                updateStatus(`üë• Connesso al torneo "${tournamentName}"!`);
                
            } catch (error) {
                console.error('‚ùå Errore:', error);
                updateStatus('‚ùå Errore accesso torneo');
            }
        }

        // üì° SINCRONIZZAZIONE REAL-TIME - FIREBASE v8
        function setupRealtimeSync() {
            if (!window.firebaseConnected || !window.firebaseDatabase) {
                console.log('üì± Firebase offline - Nessuna sincronizzazione');
                return;
            }

            try {
                console.log('üì° Attivazione sincronizzazione real-time...');
                
                // Pulisci listener precedenti
                realtimeListeners.forEach(listener => {
                    if (listener.off) listener.off();
                });
                realtimeListeners = [];

                // ‚ö° LISTENER MATCHES
                const matchesRef = window.firebaseDatabase.ref(`tournaments/${currentTournament}/matches`);
                matchesRef.on('value', (snapshot) => {
                    const newMatches = snapshot.val();
                    if (newMatches) {
                        const newMatchesStr = JSON.stringify(newMatches);
                        const currentMatchesStr = JSON.stringify(matches);
                        
                        if (newMatchesStr !== currentMatchesStr) {
                            console.log('üîÑ Aggiornamento matches da Firebase');
                            matches = newMatches;
                            updateAllDisplays();
                            updateStatus('üîÑ Dati aggiornati da altro giocatore!');
                            
                            setTimeout(() => {
                                updateStatus('üî• Firebase connesso - Sincronizzato!');
                            }, 3000);
                        }
                    }
                });
                realtimeListeners.push({ off: () => matchesRef.off() });

                // ‚ö° LISTENER STATS
                const statsRef = window.firebaseDatabase.ref(`tournaments/${currentTournament}/playerStats`);
                statsRef.on('value', (snapshot) => {
                    const newStats = snapshot.val();
                    if (newStats) {
                        const newStatsStr = JSON.stringify(newStats);
                        const currentStatsStr = JSON.stringify(playerStats);
                        
                        if (newStatsStr !== currentStatsStr) {
                            console.log('üîÑ Aggiornamento stats da Firebase');
                            playerStats = newStats;
                            updateRanking();
                            updateStats();
                        }
                    }
                });
                realtimeListeners.push({ off: () => statsRef.off() });

                console.log('‚úÖ Sincronizzazione real-time ATTIVA');
                console.log('üë• Tutti i giocatori vedranno gli aggiornamenti in tempo reale!');
                updateStatus('üì° Sincronizzazione attiva - Tutti vedono le modifiche!');
                
                setTimeout(() => {
                    updateStatus('üî• Firebase connesso - Database cloud attivo!');
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Errore sync:', error);
            }
        }

        // üèÉ‚Äç‚ôÇÔ∏è ESCI DAL TORNEO
        function leaveTournament() {
            if (confirm('Vuoi davvero cambiare torneo?')) {
                // Pulisci listener
                realtimeListeners.forEach(listener => {
                    if (listener.off) listener.off();
                });
                realtimeListeners = [];
                
                currentTournament = '';
                document.getElementById('setupSection').style.display = 'block';
                document.getElementById('tournamentActive').style.display = 'none';
                hideGameContent();
                updateStatus('‚úÖ Sistema pronto - Crea o unisciti a un torneo!');
            }
        }

        // üëÅÔ∏è MOSTRA CONTENUTO TORNEO
        function showTournament() {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('tournamentActive').style.display = 'block';
            document.getElementById('activeTournamentName').textContent = currentTournament;
            
            // Mostra sezioni del gioco
            document.getElementById('gameContent').style.display = 'block';
            document.getElementById('tournamentStats').style.display = 'grid';
            document.getElementById('rankingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('exportSection').style.display = 'block';
            
            // Crea tabelle e aggiorna tutto
            createResultsTable();
            updateAllDisplays();
        }

        // üôà NASCONDI CONTENUTO GIOCO
        function hideGameContent() {
            document.getElementById('gameContent').style.display = 'none';
            document.getElementById('tournamentStats').style.display = 'none';
            document.getElementById('rankingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('exportSection').style.display = 'none';
        }

        // üìä INIZIALIZZA STATISTICHE
        function initializePlayerStats() {
            playerStats = {};
            players.forEach(player => {
                playerStats[player] = {
                    points: 0, matches: 0, wins: 0, losses: 0,
                    setsWon: 0, setsLost: 0, gamesWon: 0, gamesLost: 0
                };
            });
        }

        // üéæ INIZIALIZZA MATCH
        function initializeMatches() {
            matches = {};
            for (let i = 0; i < players.length; i++) {
                for (let j = 0; j < players.length; j++) {
                    if (i !== j) {
                        const key = `${players[i]}vs${players[j]}`;
                        matches[key] = {
                            player1: players[i], player2: players[j],
                            sets: [], player1Sets: 0, player2Sets: 0, completed: false
                        };
                    }
                }
            }
        }

        // üìã CREA TABELLA RISULTATI
        function createResultsTable() {
            const header = document.getElementById('resultsHeader');
            const body = document.getElementById('resultsBody');
            
            // Header
            let headerRow = '<tr><th style="width: 130px;">Giocatori</th>';
            players.forEach(player => {
                const displayName = player.length > 10 ? player.substring(0, 8) + '...' : player;
                headerRow += `<th style="min-width: 95px; font-size: 11px;" title="${player}">${displayName}</th>`;
            });
            headerRow += '</tr>';
            header.innerHTML = headerRow;
            
            // Body
            let bodyHTML = '';
            players.forEach((player1, i) => {
                const displayName1 = player1.length > 10 ? player1.substring(0, 8) + '...' : player1;
                let row = `<tr><td class="player-cell" title="${player1}">${displayName1}</td>`;
                players.forEach((player2, j) => {
                    if (i === j) {
                        row += '<td class="match-diagonal">‚Äî</td>';
                    } else {
                        const key = `${player1}vs${player2}`;
                        row += `<td id="cell-${i}-${j}" class="match-cell" 
                               onclick="openMatchModal('${key}', '${player1}', '${player2}')"
                               title="Match: ${player1} vs ${player2}">
                            <div class="match-details" id="summary-${key}">
                                <div style="color: #9ca3af; font-style: italic; font-weight: 600;">vs</div>
                            </div>
                        </td>`;
                    }
                });
                row += '</tr>';
                bodyHTML += row;
            });
            body.innerHTML = bodyHTML;
        }

        // üéØ APRI MODAL MATCH
        function openMatchModal(key, player1, player2) {
            if (!currentTournament) {
                alert('‚ö†Ô∏è Unisciti prima a un torneo!');
                return;
            }
            
            currentMatchKey = key;
            const modal = document.getElementById('matchModal');
            const title = document.getElementById('modalTitle');
            const container = document.getElementById('setsContainer');
            
            title.textContent = `üéæ ${player1} vs ${player2}`;
            
            const match = matches[key];
            if (!match) {
                console.error('‚ùå Match non trovato:', key);
                return;
            }
            
            // Form per i set
            let setsHTML = '';
            for (let i = 0; i < 3; i++) {
                const set = match.sets[i] || { player1Games: '', player2Games: '' };
                const setNum = i + 1;
                
                setsHTML += `
                    <div class="set-form">
                        <label>Set ${setNum}:</label>
                        <span>${player1.length > 12 ? player1.substring(0, 10) + '...' : player1}</span>
                        <input type="number" id="p1-set${setNum}" class="set-input" min="0" max="7" 
                               value="${set.player1Games}" placeholder="0">
                        <span>-</span>
                        <input type="number" id="p2-set${setNum}" class="set-input" min="0" max="7" 
                               value="${set.player2Games}" placeholder="0">
                        <span>${player2.length > 12 ? player2.substring(0, 10) + '...' : player2}</span>
                    </div>
                `;
            }
            
            container.innerHTML = setsHTML;
            modal.style.display = 'block';
            
            setTimeout(() => {
                const firstInput = document.getElementById('p1-set1');
                if (firstInput) {
                    firstInput.focus();
                    firstInput.select();
                }
            }, 200);
        }

        // ‚ùå CHIUDI MODAL
        function closeModal() {
            document.getElementById('matchModal').style.display = 'none';
            currentMatchKey = '';
        }

        // ‚úÖ VALIDA PUNTEGGIO
        function isValidSetScore(games1, games2) {
            if (games1 < 0 || games2 < 0 || !Number.isInteger(games1) || !Number.isInteger(games2)) {
                return false;
            }
            
            // Set normale: 6-4, 6-3, etc
            if (games1 === 6 && games2 <= 4) return true;
            if (games2 === 6 && games1 <= 4) return true;
            
            // Set vantaggio: 7-5
            if (games1 === 7 && games2 === 5) return true;
            if (games2 === 7 && games1 === 5) return true;
            
            // Tie-break: 7-6
            if (games1 === 7 && games2 === 6) return true;
            if (games2 === 7 && games1 === 6) return true;
            
            return false;
        }

        // üíæ SALVA MATCH
        async function saveMatch() {
            if (!currentMatchKey || !currentTournament) {
                alert('‚ùå Errore: torneo non selezionato');
                return;
            }
            
            const match = matches[currentMatchKey];
            if (!match) {
                alert('‚ùå Errore: match non trovato');
                return;
            }
            
            const sets = [];
            let player1SetsWon = 0;
            let player2SetsWon = 0;
            
            // Leggi risultati
            for (let i = 1; i <= 3; i++) {
                const p1Input = document.getElementById(`p1-set${i}`);
                const p2Input = document.getElementById(`p2-set${i}`);
                
                if (!p1Input || !p2Input) continue;
                
                const p1Games = parseInt(p1Input.value);
                const p2Games = parseInt(p2Input.value);
                
                if (!isNaN(p1Games) && !isNaN(p2Games) && p1Input.value !== '' && p2Input.value !== '') {
                    if (!isValidSetScore(p1Games, p2Games)) {
                        alert(`‚ùå Set ${i}: Punteggio non valido (${p1Games}-${p2Games}).\n\nEsempi validi: 6-4, 6-3, 7-5, 7-6`);
                        p1Input.focus();
                        return;
                    }
                    
                    sets.push({ player1Games: p1Games, player2Games: p2Games });
                    
                    if (p1Games > p2Games) {
                        player1SetsWon++;
                    } else {
                        player2SetsWon++;
                    }
                } else if (p1Input.value !== '' || p2Input.value !== '') {
                    alert(`‚ùå Set ${i}: Inserisci entrambi i punteggi o lascia vuoto.`);
                    return;
                }
            }
            
            if (sets.length === 0) {
                alert('‚ö†Ô∏è Inserisci almeno un set valido.');
                return;
            }
            
            if (player1SetsWon < 2 && player2SetsWon < 2) {
                alert('‚ö†Ô∏è Un giocatore deve vincere almeno 2 set su 3.');
                return;
            }
            
            try {
                updateStatus('üî• Salvataggio Firebase...');
                
                // Aggiorna match
                match.sets = sets;
                match.player1Sets = player1SetsWon;
                match.player2Sets = player2SetsWon;
                match.completed = true;
                
                // Ricalcola punti
                calculatePoints();
                
                // Salva nel database
                const success = await saveToDatabase(`tournaments/${currentTournament}`, {
                    players: players,
                    matches: matches,
                    playerStats: playerStats,
                    lastUpdate: new Date().toISOString()
                });
                
                if (success) {
                    updateMatchDisplay(currentMatchKey);
                    updateRanking();
                    updateStats();
                    closeModal();
                    
                    const winner = player1SetsWon > player2SetsWon ? match.player1 : match.player2;
                    updateStatus(`üèÜ ${winner} vince ${player1SetsWon}-${player2SetsWon} - Salvato!`);
                } else {
                    updateStatus('‚ùå Errore salvataggio');
                }
                
            } catch (error) {
                console.error('‚ùå Errore:', error);
                updateStatus('‚ùå Errore durante il salvataggio');
            }
        }

        // üóëÔ∏è ELIMINA MATCH
        async function deleteMatch() {
            if (confirm('Sei sicuro di voler eliminare questo risultato?')) {
                try {
                    const match = matches[currentMatchKey];
                    if (match) {
                        match.sets = [];
                        match.player1Sets = 0;
                        match.player2Sets = 0;
                        match.completed = false;
                        
                        calculatePoints();
                        
                        const success = await saveToDatabase(`tournaments/${currentTournament}`, {
                            players: players,
                            matches: matches,
                            playerStats: playerStats,
                            lastUpdate: new Date().toISOString()
                        });
                        
                        if (success) {
                            updateMatchDisplay(currentMatchKey);
                            updateRanking();
                            updateStats();
                            updateStatus('üóëÔ∏è Risultato eliminato');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Errore:', error);
                    updateStatus('‚ùå Errore eliminazione');
                }
                
                closeModal();
            }
        }

        // üéØ AGGIORNA VISUALIZZAZIONE MATCH
        function updateMatchDisplay(key) {
            const match = matches[key];
            const summaryElement = document.getElementById(`summary-${key}`);
            
            if (!summaryElement || !match) return;
            
            if (match.completed && match.sets.length > 0) {
                let setsDisplay = '';
                match.sets.forEach((set, index) => {
                    if (index > 0) setsDisplay += ' ';
                    setsDisplay += `${set.player1Games}-${set.player2Games}`;
                });
                
                const result = `${match.player1Sets}-${match.player2Sets}`;
                summaryElement.innerHTML = `
                    <div class="match-result">${result}</div>
                    <div class="set-details">${setsDisplay}</div>
                `;
                summaryElement.parentElement.classList.add('completed-match');
            } else {
                summaryElement.innerHTML = '<div style="color: #9ca3af; font-style: italic; font-weight: 600;">vs</div>';
                summaryElement.parentElement.classList.remove('completed-match');
            }
        }

        // üßÆ CALCOLA PUNTI
        function calculatePoints() {
            initializePlayerStats();
            
            Object.values(matches).forEach(match => {
                if (match.completed && match.sets.length > 0) {
                    const player1 = match.player1;
                    const player2 = match.player2;
                    const p1Sets = match.player1Sets;
                    const p2Sets = match.player2Sets;
                    
                    playerStats[player1].matches++;
                    playerStats[player2].matches++;
                    playerStats[player1].setsWon += p1Sets;
                    playerStats[player1].setsLost += p2Sets;
                    playerStats[player2].setsWon += p2Sets;
                    playerStats[player2].setsLost += p1Sets;
                    
                    let p1Games = 0, p2Games = 0;
                    match.sets.forEach(set => {
                        p1Games += set.player1Games;
                        p2Games += set.player2Games;
                    });
                    
                    playerStats[player1].gamesWon += p1Games;
                    playerStats[player1].gamesLost += p2Games;
                    playerStats[player2].gamesWon += p2Games;
                    playerStats[player2].gamesLost += p1Games;
                    
                    if (p1Sets > p2Sets) {
                        playerStats[player1].wins++;
                        playerStats[player2].losses++;
                        
                        if (p1Sets === 2 && p2Sets === 0) {
                            playerStats[player1].points += 3;
                        } else {
                            playerStats[player1].points += 2;
                            playerStats[player2].points += 1;
                        }
                    } else {
                        playerStats[player2].wins++;
                        playerStats[player1].losses++;
                        
                        if (p2Sets === 2 && p1Sets === 0) {
                            playerStats[player2].points += 3;
                        } else {
                            playerStats[player2].points += 2;
                            playerStats[player1].points += 1;
                        }
                    }
                }
            });
        }

        // üèÜ AGGIORNA CLASSIFICA
        function updateRanking() {
            const tbody = document.getElementById('rankingBody');
            if (!tbody) return;
            
            const sortedPlayers = players.slice().sort((a, b) => {
                const aStats = playerStats[a];
                const bStats = playerStats[b];
                
                if (bStats.points !== aStats.points) {
                    return bStats.points - aStats.points;
                }
                
                const aSetDiff = aStats.setsWon - aStats.setsLost;
                const bSetDiff = bStats.setsWon - bStats.setsLost;
                if (bSetDiff !== aSetDiff) {
                    return bSetDiff - aSetDiff;
                }
                
                const aGameDiff = aStats.gamesWon - aStats.gamesLost;
                const bGameDiff = bStats.gamesWon - bStats.gamesLost;
                return bGameDiff - aGameDiff;
            });
            
            let html = '';
            sortedPlayers.forEach((player, index) => {
                const stats = playerStats[player];
                const setDiff = stats.setsWon - stats.setsLost;
                const gameDiff = stats.gamesWon - stats.gamesLost;
                const avgPoints = stats.matches > 0 ? (stats.points / stats.matches).toFixed(2) : '0.00';
                
                let rowClass = '';
                if (index === 0) rowClass = 'first-place';
                else if (index === 1) rowClass = 'second-place';
                else if (index === 2) rowClass = 'third-place';
                
                const playerName = player.length > 12 ? player.substring(0, 10) + '...' : player;
                
                html += `
                    <tr class="${rowClass}">
                        <td><strong>${index + 1}</strong></td>
                        <td title="${player}"><strong>${playerName}</strong></td>
                        <td><strong>${stats.points}</strong></td>
                        <td>${stats.matches}</td>
                        <td>${stats.wins}-${stats.losses}</td>
                        <td>${stats.setsWon}-${stats.setsLost}</td>
                        <td>${setDiff > 0 ? '+' : ''}${setDiff}</td>
                        <td>${stats.gamesWon}-${stats.gamesLost}</td>
                        <td>${gameDiff > 0 ? '+' : ''}${gameDiff}</td>
                        <td>${avgPoints}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // üìä AGGIORNA STATISTICHE
        function updateStats() {
            const totalMatches = (players.length * (players.length - 1)) / 2;
            let playedMatches = 0;
            let totalSets = 0;
            
            const countedPairs = new Set();
            
            Object.values(matches).forEach(match => {
                if (match.completed) {
                    const pair1 = `${match.player1}-${match.player2}`;
                    const pair2 = `${match.player2}-${match.player1}`;
                    
                    if (!countedPairs.has(pair1) && !countedPairs.has(pair2)) {
                        playedMatches++;
                        totalSets += match.sets.length;
                        countedPairs.add(pair1);
                    }
                }
            });
            
            const completionPercentage = totalMatches > 0 ? Math.round((playedMatches / totalMatches) * 100) : 0;
            
            document.getElementById('matchesPlayed').textContent = playedMatches;
            document.getElementById('totalMatches').textContent = totalMatches;
            document.getElementById('completionPercentage').textContent = `${completionPercentage}%`;
            document.getElementById('totalSets').textContent = totalSets;
        }

        // üîÑ AGGIORNA TUTTE LE VISUALIZZAZIONI
        function updateAllDisplays() {
            Object.keys(matches).forEach(key => {
                updateMatchDisplay(key);
            });
            calculatePoints();
            updateRanking();
            updateStats();
        }

        // üì§ EXPORT/IMPORT JSON
        function exportAllData() {
            try {
                const exportData = {
                    tournamentName: currentTournament,
                    players: players,
                    matches: matches,
                    playerStats: playerStats,
                    exportDate: new Date().toISOString(),
                    version: '3.0'
                };
                
                const jsonData = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `torneo_${currentTournament}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                updateStatus('üì§ JSON esportato con successo!');
            } catch (error) {
                console.error('‚ùå Errore export:', error);
                alert('‚ùå Errore durante l\'export');
            }
        }
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (!data.matches || !data.playerStats || !data.players) {
                            throw new Error('File JSON non valido');
                        }
                        
                        // Carica i dati
                        currentTournament = data.tournamentName || 'Torneo Importato';
                        players = data.players;
                        matches = data.matches;
                        playerStats = data.playerStats;
                        
                        // Salva nel database locale
                        await saveToDatabase(`tournaments/${currentTournament}`, {
                            players: players,
                            matches: matches,
                            playerStats: playerStats,
                            lastUpdate: new Date().toISOString()
                        });
                        
                        // Mostra il torneo
                        showTournament();
                        updateAllDisplays();
                        
                        updateStatus('üì• Dati importati con successo!');
                        alert(`‚úÖ Torneo "${currentTournament}" importato con successo!\n\n${Object.values(matches).filter(m => m.completed).length} match caricati.`);
                        
                    } catch (error) {
                        console.error('‚ùå Errore import:', error);
                        alert('‚ùå Errore: File JSON non valido o corrotto');
                    }
                };
                
                reader.readAsText(file);
            };
            
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }
        
        // üì§ EXPORT CSV
        function exportToCSV() {
            const sortedPlayers = players.slice().sort((a, b) => {
                const aStats = playerStats[a];
                const bStats = playerStats[b];
                
                if (bStats.points !== aStats.points) return bStats.points - aStats.points;
                
                const aSetDiff = aStats.setsWon - aStats.setsLost;
                const bSetDiff = bStats.setsWon - bStats.setsLost;
                if (bSetDiff !== aSetDiff) return bSetDiff - aSetDiff;
                
                const aGameDiff = aStats.gamesWon - aStats.gamesLost;
                const bGameDiff = bStats.gamesWon - bStats.gamesLost;
                return bGameDiff - aGameDiff;
            });
            
            let csv = 'Posizione,Giocatore,Punti,Partite,Vittorie,Sconfitte,Set Vinti,Set Persi,Diff Set,Games Vinti,Games Persi,Diff Games,Media Punti\n';
            
            sortedPlayers.forEach((player, index) => {
                const stats = playerStats[player];
                const setDiff = stats.setsWon - stats.setsLost;
                const gameDiff = stats.gamesWon - stats.gamesLost;
                const avgPoints = stats.matches > 0 ? (stats.points / stats.matches).toFixed(2) : '0.00';
                
                csv += `${index + 1},"${player}",${stats.points},${stats.matches},${stats.wins},${stats.losses},${stats.setsWon},${stats.setsLost},${setDiff},${stats.gamesWon},${stats.gamesLost},${gameDiff},${avgPoints}\n`;
            });
            
            downloadCSV(csv, `classifica_${currentTournament}.csv`);
        }
        
        function exportResultsToCSV() {
            let csv = 'Giocatore 1,Giocatore 2,Set G1,Set G2,Vincitore,Punti G1,Punti G2,Set Dettaglio\n';
            
            const processedMatches = new Set();
            
            Object.values(matches).forEach(match => {
                if (match.completed) {
                    const matchKey = `${match.player1}-${match.player2}`;
                    const reverseKey = `${match.player2}-${match.player1}`;
                    
                    if (!processedMatches.has(matchKey) && !processedMatches.has(reverseKey)) {
                        const winner = match.player1Sets > match.player2Sets ? match.player1 : match.player2;
                        
                        let p1Points = 0, p2Points = 0;
                        if (match.player1Sets > match.player2Sets) {
                            p1Points = match.player1Sets === 2 && match.player2Sets === 0 ? 3 : 2;
                            p2Points = match.player2Sets === 1 ? 1 : 0;
                        } else {
                            p2Points = match.player2Sets === 2 && match.player1Sets === 0 ? 3 : 2;
                            p1Points = match.player1Sets === 1 ? 1 : 0;
                        }
                        
                        let setDetails = match.sets.map(set => `${set.player1Games}-${set.player2Games}`).join(' ');
                        
                        csv += `"${match.player1}","${match.player2}",${match.player1Sets},${match.player2Sets},"${winner}",${p1Points},${p2Points},"${setDetails}"\n`;
                        processedMatches.add(matchKey);
                    }
                }
            });
            
            downloadCSV(csv, `risultati_${currentTournament}.csv`);
        }
        
        function exportDetailedResults() {
            let csv = 'Giocatore 1,Giocatore 2,Set 1,Set 2,Set 3,Vincitore,Games G1,Games G2,Data\n';
            
            const processedMatches = new Set();
            
            Object.values(matches).forEach(match => {
                if (match.completed) {
                    const matchKey = `${match.player1}-${match.player2}`;
                    const reverseKey = `${match.player2}-${match.player1}`;
                    
                    if (!processedMatches.has(matchKey) && !processedMatches.has(reverseKey)) {
                        const winner = match.player1Sets > match.player2Sets ? match.player1 : match.player2;
                        
                        const set1 = match.sets[0] ? `${match.sets[0].player1Games}-${match.sets[0].player2Games}` : '';
                        const set2 = match.sets[1] ? `${match.sets[1].player1Games}-${match.sets[1].player2Games}` : '';
                        const set3 = match.sets[2] ? `${match.sets[2].player1Games}-${match.sets[2].player2Games}` : '';
                        
                        let totalGamesP1 = 0, totalGamesP2 = 0;
                        match.sets.forEach(set => {
                            totalGamesP1 += set.player1Games;
                            totalGamesP2 += set.player2Games;
                        });
                        
                        csv += `"${match.player1}","${match.player2}","${set1}","${set2}","${set3}","${winner}",${totalGamesP1},${totalGamesP2},"${new Date().toLocaleDateString()}"\n`;
                        processedMatches.add(matchKey);
                    }
                }
            });
            
            downloadCSV(csv, `dettagliati_${currentTournament}.csv`);
        }
        
        function downloadCSV(content, filename) {
            try {
                const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                updateStatus('üìä File CSV scaricato!');
            } catch (error) {
                console.error('‚ùå Errore download:', error);
                updateStatus('‚ùå Errore download CSV');
            }
        }
        
        // üìã COPIA LINK
        function copyLink() {
            const link = 'https://paul690182.github.io/torneo-tennis-2025/';
            
            // Prova con Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(link)
                    .then(() => {
                        updateStatus('üìã Link copiato! Invialo agli altri giocatori');
                        alert('‚úÖ Link copiato negli appunti!\n\nInvialo agli altri giocatori via WhatsApp, Email, ecc.');
                        setTimeout(() => {
                            updateStatus('üî• Firebase connesso - Database cloud attivo!');
                        }, 3000);
                    })
                    .catch(err => {
                        // Fallback
                        fallbackCopy(link);
                    });
            } else {
                // Fallback per browser vecchi
                fallbackCopy(link);
            }
        }
        
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                updateStatus('üìã Link copiato! Invialo agli altri giocatori');
                alert('‚úÖ Link copiato negli appunti!\n\nInvialo agli altri giocatori.');
            } catch (err) {
                alert('üìã Copia questo link e invialo agli altri:\n\n' + text);
            }
            
            document.body.removeChild(textarea);
        }
        
        // üì§ CONDIVIDI VIA LINK - SISTEMA AVANZATO
        function shareViaLink() {
            try {
                updateStatus('üîó Generazione link condivisione...');
                
                // Comprimi i dati del torneo
                const tournamentData = {
                    name: currentTournament,
                    players: players,
                    matches: matches,
                    playerStats: playerStats,
                    timestamp: Date.now()
                };
                
                // Converti in JSON e comprimi con base64
                const jsonData = JSON.stringify(tournamentData);
                const encoded = btoa(encodeURIComponent(jsonData));
                
                // Crea URL con dati
                const baseUrl = window.location.origin + window.location.pathname;
                const shareUrl = `${baseUrl}?data=${encoded}`;
                
                // Mostra il link
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%;">
                        <h2 style="margin: 0 0 20px 0; color: #1f2937;">üîó Link di Condivisione</h2>
                        <p style="color: #6b7280; margin-bottom: 20px;">
                            Copia questo link e invialo agli altri giocatori.<br>
                            Quando lo apriranno, vedranno tutti i risultati aggiornati!
                        </p>
                        <textarea id="shareLink" readonly style="
                            width: 100%;
                            height: 100px;
                            padding: 15px;
                            border: 2px solid #3b82f6;
                            border-radius: 10px;
                            font-family: monospace;
                            font-size: 12px;
                            resize: none;
                            margin-bottom: 20px;
                        ">${shareUrl}</textarea>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="
                                padding: 12px 24px;
                                background: #6b7280;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                            ">Chiudi</button>
                            <button onclick="
                                document.getElementById('shareLink').select();
                                document.execCommand('copy');
                                alert('‚úÖ Link copiato!');
                            " style="
                                padding: 12px 24px;
                                background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                            ">üìã Copia Link</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Seleziona il link
                setTimeout(() => {
                    document.getElementById('shareLink').select();
                }, 100);
                
                updateStatus('‚úÖ Link generato - Copialo e condividilo!');
                
            } catch (error) {
                console.error('‚ùå Errore generazione link:', error);
                alert('‚ùå Errore durante la generazione del link');
            }
        }
        
        // üì• CARICA DA LINK
        function loadFromURL() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const encodedData = urlParams.get('data');
                
                if (!encodedData) {
                    console.log('‚ÑπÔ∏è Nessun dato nell\'URL');
                    return false;
                }
                
                console.log('üì• Dati trovati nell\'URL - Caricamento...');
                updateStatus('üì• Caricamento dati dal link...');
                
                // Decodifica
                const jsonData = decodeURIComponent(atob(encodedData));
                const tournamentData = JSON.parse(jsonData);
                
                // Carica i dati
                currentTournament = tournamentData.name;
                players = tournamentData.players;
                matches = tournamentData.matches;
                playerStats = tournamentData.playerStats;
                
                // Salva in localStorage
                saveToDatabase(`tournaments/${currentTournament}`, {
                    players: players,
                    matches: matches,
                    playerStats: playerStats,
                    lastUpdate: new Date().toISOString()
                });
                
                // Mostra il torneo
                showTournament();
                updateAllDisplays();
                
                updateStatus('‚úÖ Dati caricati dal link condiviso!');
                
                setTimeout(() => {
                    alert(`‚úÖ Torneo "${currentTournament}" caricato dal link!\n\n` +
                          `${Object.values(matches).filter(m => m.completed).length} partite caricate.\n\n` +
                          `Puoi ora inserire nuovi risultati!`);
                }, 500);
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Errore caricamento da URL:', error);
                return false;
            }
        }
        
        // üîÑ RESET TORNEO
        async function resetTournament() {
            if (confirm('‚ö†Ô∏è Sei sicuro di voler resettare tutto il torneo?\n\nTutti i risultati andranno persi definitivamente.')) {
                try {
                    updateStatus('üîÑ Reset in corso...');
                    
                    initializePlayerStats();
                    initializeMatches();
                    
                    const success = await saveToDatabase(`tournaments/${currentTournament}`, {
                        players: players,
                        matches: matches,
                        playerStats: playerStats,
                        created: new Date().toISOString(),
                        lastUpdate: new Date().toISOString()
                    });
                    
                    if (success) {
                        updateAllDisplays();
                        updateStatus('üîÑ Torneo resettato con successo!');
                    } else {
                        updateStatus('‚ùå Errore durante il reset');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Errore:', error);
                    updateStatus('‚ùå Errore durante il reset');
                }
            }
        }

        // üéÆ EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM caricato');
            
            // Aspetta che Firebase sia pronto
            const waitForFirebase = setInterval(() => {
                if (window.firebaseReady) {
                    clearInterval(waitForFirebase);
                    console.log('‚úÖ Firebase pronto, avvio app...');
                    
                    if (window.initApp) {
                        window.initApp();
                    } else {
                        console.error('‚ùå initApp non trovata!');
                    }
                }
            }, 100);
            
            // Timeout di sicurezza
            setTimeout(() => {
                clearInterval(waitForFirebase);
                if (!window.appStarted && window.initApp) {
                    console.log('‚è∞ Avvio forzato app');
                    window.initApp();
                }
            }, 3000);
            
            // Event listeners modal
            const closeBtn = document.querySelector('.close');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
            }
            
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('matchModal');
                if (event.target === modal) {
                    closeModal();
                }
            });
            
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modal = document.getElementById('matchModal');
                    if (modal && modal.style.display === 'block') {
                        closeModal();
                    }
                }
                
                if (event.key === 'Enter' && event.target.classList.contains('set-input')) {
                    const inputs = document.querySelectorAll('.set-input');
                    const currentIndex = Array.from(inputs).indexOf(event.target);
                    if (currentIndex < inputs.length - 1) {
                        inputs[currentIndex + 1].focus();
                        inputs[currentIndex + 1].select();
                    } else {
                        saveMatch();
                    }
                    event.preventDefault();
                }
            });

            // Enter su input nome torneo
            const tournamentInput = document.getElementById('tournamentName');
            if (tournamentInput) {
                tournamentInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        joinTournament();
                    }
                });
                console.log('‚úÖ Event listener input torneo aggiunto');
            }
            
            console.log('‚úÖ Event listeners configurati');
        });

        // Rende funzioni disponibili globalmente per onclick
        window.createTournament = createTournament;
        window.joinTournament = joinTournament;
        window.leaveTournament = leaveTournament;
        window.copyLink = copyLink;
        window.shareViaLink = shareViaLink;
        window.openMatchModal = openMatchModal;
        window.closeModal = closeModal;
        window.saveMatch = saveMatch;
        window.deleteMatch = deleteMatch;
        window.exportToCSV = exportToCSV;
        window.exportResultsToCSV = exportResultsToCSV;
        window.exportDetailedResults = exportDetailedResults;
        window.exportAllData = exportAllData;
        window.importData = importData;
        window.resetTournament = resetTournament;
        
        // üîó Carica dati da URL se presenti
        setTimeout(() => {
            loadFromURL();
        }, 1000);
    </script>
</body>
</html><!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo Tennis Cloud - Database Permanente</title>
    
    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, push, child } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // üî• CONFIGURAZIONE FIREBASE PUBBLICA
        const firebaseConfig = {
            apiKey: "AIzaSyBqJ7hf8KbqJ_Dw9lLFn5pNc0hVgGLqKoM",
            authDomain: "torneo-tennis-cloud.firebaseapp.com",
            databaseURL: "https://torneo-tennis-cloud-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "torneo-tennis-cloud",
            storageBucket: "torneo-tennis-cloud.appspot.com",
            messagingSenderId: "489572338120",
            appId: "1:489572338120:web:8c7d0a9f1e2b3c4d5e6789"
        };

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Rende disponibili globalmente
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseOnValue = onValue;
        window.firebasePush = push;
        window.firebaseChild = child;
        
        console.log('üî• Firebase inizializzato correttamente');
        
        // Segnala che Firebase √® pronto
        window.firebaseReady = true;
        if (window.initApp) {
            window.initApp();
        }
    </script>
    
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1a202c;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 40px;
            font-size: 3.2em;
            font-weight: 900;
            letter-spacing: -2px;
            text-shadow: none;
        }

        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 700;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            backdrop-filter: blur(10px);
        }

        .main-content {
            margin-top: 70px;
        }

        .firebase-info {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }

        .firebase-info h2 {
            margin: 0 0 20px 0;
            font-size: 2em;
            font-weight: 800;
        }

        .firebase-info p {
            margin: 15px 0;
            font-size: 1.1em;
            opacity: 0.95;
        }

        .setup-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 35px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
        }

        .setup-section h2 {
            margin: 0 0 25px 0;
            font-size: 2.2em;
            font-weight: 800;
        }

        .tournament-input {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin: 25px 0;
        }

        .tournament-input input {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            min-width: 250px;
            background: rgba(255,255,255,0.95);
            color: #1a202c;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .tournament-input input:focus {
            outline: none;
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .tournament-input button {
            padding: 16px 30px;
            background: #ffffff;
            color: #667eea;
            border: none;
            border-radius: 12px;
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tournament-input button:hover {
            background: #f7fafc;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .tournament-active {
            background: linear-gradient(135deg, #10b981, #059669);
            border: 2px solid rgba(16, 185, 129, 0.3);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin: 25px 0;
            text-align: center;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.2);
        }

        .tournament-active h3 {
            margin: 0 0 15px 0;
            font-size: 1.8em;
            font-weight: 800;
        }

        .tournament-active button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tournament-active button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .points-legend {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            color: #92400e;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.2);
        }

        .points-legend h3 {
            margin-top: 0;
            color: #92400e;
            font-weight: 800;
            font-size: 1.6em;
        }

        .section {
            margin-bottom: 40px;
        }
        
        h2 {
            color: #1a202c;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 800;
            letter-spacing: -1px;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 25px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            background: #ffffff;
        }
        
        th, td {
            border: none;
            border-bottom: 1px solid #e2e8f0;
            padding: 18px 15px;
            text-align: center;
            transition: all 0.3s ease;
            color: #2d3748;
        }
        
        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #ffffff;
            font-weight: 800;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        tr:nth-child(even) td {
            background-color: #f8fafc;
        }
        
        tr:hover td {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            transform: scale(1.02);
        }
        
        .match-cell {
            padding: 10px !important;
            width: 95px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            background: #ffffff;
            border-radius: 8px;
        }
        
        .match-cell:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)) !important;
            transform: scale(1.12);
            z-index: 10;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .player-cell {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            color: white;
            font-weight: 800;
            width: 130px;
            font-size: 1em;
            cursor: help;
        }
        
        .completed-match {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2)) !important;
            font-weight: 800;
            border: 2px solid rgba(16, 185, 129, 0.4);
            border-radius: 10px;
        }
        
        .match-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            line-height: 1.4;
            padding: 4px;
        }
        
        .match-result {
            font-weight: 900;
            color: #1a202c;
            font-size: 14px;
        }
        
        .set-details {
            font-size: 10px;
            color: #4a5568;
            white-space: nowrap;
        }
        
        .ranking-table {
            background: #ffffff;
            border-radius: 25px;
            overflow: hidden;
            border: 3px solid #667eea;
        }
        
        .first-place {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.4), rgba(255, 237, 78, 0.4)) !important;
            font-weight: 900;
            border: 2px solid #ffd700;
            border-radius: 12px;
            animation: champion-glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes champion-glow {
            from { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
            to { box-shadow: 0 0 40px rgba(255, 215, 0, 0.6); }
        }
        
        .second-place {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.4), rgba(229, 229, 229, 0.4)) !important;
            font-weight: 800;
            border: 2px solid #c0c0c0;
            border-radius: 12px;
        }
        
        .third-place {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.4), rgba(218, 165, 32, 0.4)) !important;
            font-weight: 800;
            border: 2px solid #cd7f32;
            border-radius: 12px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 30px;
            margin: 40px 0;
        }
        
        .stat-item {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 2px solid #667eea;
            color: #1a202c;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
            transition: all 0.4s ease;
        }

        .stat-item:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
        }

        .stat-item div:first-child {
            font-size: 1em;
            opacity: 0.8;
            margin-bottom: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .stat-item div:last-child {
            font-size: 2.8em;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 15px;
            cursor: pointer;
            margin: 15px 10px;
            font-weight: 800;
            font-size: 1em;
            transition: all 0.4s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .export-btn:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .reset-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .reset-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            box-shadow: 0 15px 35px rgba(239, 68, 68, 0.4);
        }
        
        .match-diagonal {
            background: linear-gradient(135deg, #94a3b8, #64748b) !important;
            color: white;
            font-weight: 800;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            margin: 3% auto;
            padding: 45px;
            border-radius: 25px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
            border: 3px solid #667eea;
        }
        
        .close {
            color: #667eea;
            float: right;
            font-size: 36px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .close:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            transform: rotate(180deg) scale(1.2);
        }
        
        .match-form {
            display: flex;
            flex-direction: column;
            gap: 30px;
            margin-top: 35px;
        }
        
        .set-form {
            display: flex;
            align-items: center;
            gap: 25px;
            padding: 25px;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 2px solid #667eea;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .set-form:hover {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e0);
            border-color: #764ba2;
            transform: translateY(-2px);
        }

        .set-form label {
            font-weight: 800;
            color: #1a202c;
            min-width: 90px;
            font-size: 1.1em;
        }

        .set-form span {
            font-weight: 700;
            color: #2d3748;
            font-size: 1em;
        }

        .set-input {
            width: 80px;
            height: 55px;
            padding: 15px;
            border: 3px solid #667eea;
            border-radius: 15px;
            text-align: center;
            font-size: 20px;
            font-weight: 900;
            background: #ffffff;
            color: #1a202c;
            transition: all 0.3s ease;
        }

        .set-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.2);
            transform: scale(1.08);
        }
        
        .save-match-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 800;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.4s ease;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .save-match-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4);
        }
        
        .delete-match-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 800;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: 20px;
            transition: all 0.4s ease;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        
        .delete-match-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 15px 40px rgba(239, 68, 68, 0.4);
        }

        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .connecting {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
        }

        .error {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 25px;
            }

            h1 {
                font-size: 2.2em;
                margin-bottom: 30px;
            }

            .match-cell {
                width: 80px;
                font-size: 11px;
                padding: 8px !important;
            }

            .tournament-input {
                flex-direction: column;
                gap: 15px;
            }

            .tournament-input input {
                min-width: 100%;
            }

            .modal-content {
                width: 95%;
                padding: 25px;
            }

            .set-form {
                flex-wrap: wrap;
                gap: 15px;
                padding: 20px;
            }

            .set-input {
                width: 65px;
                height: 50px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="status-bar" id="statusBar">
        ‚úÖ Sistema pronto - Crea o unisciti a un torneo!
    </div>

    <div class="container">
        <div class="main-content">
            <h1>üî• Torneo Tennis Firebase</h1>
            
            <!-- Info Firebase REALE -->
            <div class="firebase-info">
                <h2>üî• Firebase Cloud Database - ATTIVO</h2>
                <p><strong>‚òÅÔ∏è Database condiviso nel cloud</strong> ‚Ä¢ <strong>üîÑ Sincronizzazione real-time</strong> ‚Ä¢ <strong>üåç Visibile da tutti</strong></p>
                <p><strong>üí° Tutti i giocatori vedranno gli stessi risultati!</strong> Basta condividere il nome del torneo.</p>
                <div id="connectionStatus" style="margin-top: 15px; padding: 15px; border-radius: 10px; background: rgba(16, 185, 129, 0.2); border: 2px solid #10b981;">
                    <strong>üî• Il tuo database Firebase √® attivo!</strong><br>
                    <span style="font-size: 0.9em; opacity: 0.9;">Tutti con lo stesso nome torneo vedranno i dati sincronizzati automaticamente</span>
                </div>
            </div>
            
            <!-- Setup iniziale -->
            <div class="setup-section" id="setupSection">
                <h2>üèÜ Crea o Unisciti al Torneo</h2>
                <p style="font-size: 1.2em; margin: 20px 0;">I tuoi dati saranno salvati permanentemente e sincronizzati in tempo reale!</p>
                
                <div class="tournament-input">
                    <input type="text" id="tournamentName" placeholder="Nome torneo (es: TennisClub2025)" 
                           value="TorneoTennis2025" maxlength="50">
                    <button onclick="createTournament()">üöÄ Crea Torneo</button>
                    <button onclick="joinTournament()">üéØ Unisciti</button>
                </div>
            </div>

            <!-- Torneo attivo -->
            <div class="tournament-active" id="tournamentActive" style="display: none;">
                <h3>üèÜ Torneo Attivo: <span id="activeTournamentName"></span></h3>
                <p>üì° Sincronizzazione Firebase attiva ‚Ä¢ ‚òÅÔ∏è Database condiviso ‚Ä¢ üë• Tutti vedono le modifiche in tempo reale<br>
                <button onclick="leaveTournament()">üîÑ Cambia Torneo</button></p>
                <div style="margin-top: 15px; padding: 12px; background: rgba(16, 185, 129, 0.3); border-radius: 8px; font-size: 0.9em;">
                    <strong>üåê Condividi questo link con gli altri:</strong><br>
                    <code style="background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 6px; display: inline-block; margin-top: 8px; cursor: pointer;" onclick="copyLink()" title="Clicca per copiare">
                        https://paul690182.github.io/torneo-tennis-2025/
                    </code>
                    <button onclick="copyLink()" style="margin-left: 10px; padding: 8px 16px; background: rgba(255,255,255,0.9); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: #059669;">üìã Copia Link</button>
                </div>
            </div>
            
            <div class="points-legend" id="gameContent" style="display: none;">
                <h3>üìä Sistema di Punteggio</h3>
                <ul>
                    <li><strong>3 punti</strong> - Vittoria 2-0 (set)</li>
                    <li><strong>2 punti</strong> - Vittoria 2-1 (set)</li>
                    <li><strong>1 punto</strong> - Sconfitta 2-1 (set)</li>
                    <li><strong>0 punti</strong> - Sconfitta 2-0 (set)</li>
                </ul>
                <p><em>üí° Clicca su una cella della tabella risultati per inserire il punteggio. Ogni risultato viene salvato istantaneamente nel cloud Firebase!</em></p>
            </div>
            
            <div class="stats" id="tournamentStats" style="display: none;">
                <div class="stat-item">
                    <div>Partite Giocate</div>
                    <div id="matchesPlayed">0</div>
                </div>
                <div class="stat-item">
                    <div>Partite Totali</div>
                    <div id="totalMatches">66</div>
                </div>
                <div class="stat-item">
                    <div>Completamento</div>
                    <div id="completionPercentage">0%</div>
                </div>
                <div class="stat-item">
                    <div>Set Giocati</div>
                    <div id="totalSets">0</div>
                </div>
            </div>
            
            <div class="section" id="rankingSection" style="display: none;">
                <h2>üèÜ Classifica Generale</h2>
                <table class="ranking-table" id="rankingTable">
                    <thead>
                        <tr>
                            <th>Pos.</th>
                            <th>Giocatore</th>
                            <th>Punti</th>
                            <th>Partite</th>
                            <th>V-S</th>
                            <th>Set V-P</th>
                            <th>Diff. Set</th>
                            <th>Games V-P</th>
                            <th>Diff. Games</th>
                            <th>Media</th>
                        </tr>
                    </thead>
                    <tbody id="rankingBody">
                    </tbody>
                </table>
            </div>
            
            <div class="section" id="resultsSection" style="display: none;">
                <h2>üìã Tabella Risultati</h2>
                <p><em>üí° Clicca su una cella per inserire il risultato - Salvataggio automatico Firebase</em></p>
                <div style="overflow-x: auto;">
                    <table id="resultsTable">
                        <thead id="resultsHeader">
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="section" id="exportSection" style="display: none;">
                <button class="export-btn" onclick="shareViaLink()" style="background: linear-gradient(135deg, #10b981, #059669); font-size: 1.1em; padding: 20px 40px;">üîó CONDIVIDI VIA LINK</button>
                <button class="export-btn" onclick="exportToCSV()">üìä Esporta Classifica CSV</button>
                <button class="export-btn" onclick="exportResultsToCSV()">üìã Esporta Risultati CSV</button>
                <button class="export-btn" onclick="exportDetailedResults()">üìà Esporta Dettagliati CSV</button>
                <button class="export-btn" onclick="exportAllData()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">üì§ Esporta JSON Completo</button>
                <button class="export-btn" onclick="importData()" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">üì• Importa JSON</button>
                <button class="export-btn reset-btn" onclick="resetTournament()">üîÑ Reset Torneo</button>
                
                <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 16px; border: 2px solid #f59e0b;">
                    <h3 style="margin: 0 0 15px 0; color: #92400e;">üí° Come condividere con altri giocatori:</h3>
                    <ol style="margin: 0; padding-left: 20px; color: #92400e; line-height: 1.8;">
                        <li><strong>Clicca "üîó CONDIVIDI VIA LINK"</strong> dopo aver inserito risultati</li>
                        <li><strong>Copia il link</strong> che appare</li>
                        <li><strong>Invia il link</strong> agli altri via WhatsApp, Email, ecc.</li>
                        <li><strong>Gli altri aprono il link</strong> e vedono tutti i risultati!</li>
                        <li><strong>Quando aggiungono risultati</strong>, ri-condividono il nuovo link</li>
                    </ol>
                    <p style="margin: 15px 0 0 0; font-weight: 600; color: #78350f;">
                        ‚ö° Funziona sempre, anche senza database cloud!
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per inserimento risultato -->
    <div id="matchModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Inserisci Risultato Match</h2>
            <div class="match-form" id="matchForm">
                <div id="setsContainer"></div>
                <div>
                    <button class="save-match-btn" onclick="saveMatch()">üî• Salva su Firebase</button>
                    <button class="delete-match-btn" onclick="deleteMatch()">üóëÔ∏è Elim
