<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo Tennis Dinamico - Database Cloud</title>
    
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f1f5f9;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        h1 {
            text-align: center;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 40px;
            font-size: 3em;
            font-weight: 800;
            letter-spacing: -2px;
        }

        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .main-content {
            margin-top: 60px;
        }

        .setup-section {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            text-align: center;
        }

        .setup-section h2 {
            margin: 0 0 20px 0;
            font-size: 1.8em;
        }

        .tournament-input {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .tournament-input input {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            min-width: 200px;
            background: rgba(255,255,255,0.95);
        }

        .tournament-input button {
            padding: 12px 24px;
            background: #ffffff;
            color: #3b82f6;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tournament-input button:hover {
            background: #f8fafc;
            transform: translateY(-2px);
        }

        .info-panel {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .info-panel h3 {
            margin: 0 0 15px 0;
            color: #92400e;
        }

        .tournament-active {
            background: #dcfce7;
            border: 1px solid #16a34a;
            color: #15803d;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }

        .tournament-active h3 {
            margin: 0 0 10px 0;
            color: #15803d;
        }

        .points-legend {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
        }

        .points-legend h3 {
            margin-top: 0;
            color: #1f2937;
            font-weight: 700;
        }

        .points-legend ul {
            margin: 15px 0;
            padding-left: 25px;
        }

        .points-legend li {
            margin: 12px 0;
            color: #374151;
            font-weight: 500;
        }

        .section {
            margin-bottom: 40px;
        }
        
        h2 {
            color: #1f2937;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 15px;
            margin-bottom: 25px;
            font-size: 1.9em;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 20px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: #ffffff;
        }
        
        th, td {
            border: none;
            border-bottom: 1px solid #e2e8f0;
            padding: 16px 12px;
            text-align: center;
            transition: all 0.3s ease;
            color: #374151;
        }
        
        th {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: #ffffff;
            font-weight: 700;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        tr:nth-child(even) td {
            background-color: #f8fafc;
        }
        
        tr:hover td {
            background: #e0f2fe;
            transform: scale(1.02);
        }
        
        .match-cell {
            padding: 8px !important;
            width: 90px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .match-cell:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(29, 78, 216, 0.3)) !important;
            transform: scale(1.08);
            z-index: 10;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);
        }
        
        .player-cell {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
            color: white;
            font-weight: 700;
            width: 120px;
            font-size: 0.9em;
            cursor: help;
        }
        
        .completed-match {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2)) !important;
            font-weight: 700;
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
        }
        
        .match-details {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            line-height: 1.3;
            padding: 2px;
        }
        
        .match-result {
            font-weight: bold;
            color: #1f2937;
            font-size: 13px;
        }
        
        .set-details {
            font-size: 9px;
            color: #6b7280;
            white-space: nowrap;
        }
        
        .ranking-table {
            background: #ffffff;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .first-place {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 237, 78, 0.3)) !important;
            font-weight: 800;
            border: 1px solid rgba(255, 215, 0, 0.5);
            border-radius: 8px;
        }
        
        .second-place {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.3), rgba(229, 229, 229, 0.3)) !important;
            font-weight: 700;
            border: 1px solid rgba(192, 192, 192, 0.5);
            border-radius: 8px;
        }
        
        .third-place {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.3), rgba(218, 165, 32, 0.3)) !important;
            font-weight: 700;
            border: 1px solid rgba(205, 127, 50, 0.5);
            border-radius: 8px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            margin: 40px 0;
        }
        
        .stat-item {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(29, 78, 216, 0.1));
            border: 1px solid #e2e8f0;
            color: #1f2937;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-item div:first-child {
            font-size: 0.95em;
            opacity: 0.8;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-item div:last-child {
            font-size: 2.2em;
            font-weight: 800;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            margin: 12px 8px;
            font-weight: 700;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .export-btn:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .reset-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .reset-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        .match-diagonal {
            background: linear-gradient(135deg, #94a3b8, #64748b) !important;
            color: white;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
        }
        
        .modal-content {
            background: #ffffff;
            margin: 5% auto;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 650px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }
        
        .close {
            color: #6b7280;
            float: right;
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.05);
        }
        
        .close:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            transform: rotate(90deg) scale(1.1);
        }
        
        .match-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-top: 30px;
        }
        
        .set-form {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        .set-form:hover {
            background: #f1f5f9;
            border-color: #3b82f6;
        }

        .set-form label {
            font-weight: 700;
            color: #1f2937;
            min-width: 80px;
            font-size: 1em;
        }

        .set-form span {
            font-weight: 600;
            color: #374151;
            font-size: 0.9em;
        }

        .set-input {
            width: 70px;
            height: 50px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            background: #ffffff;
            color: #1f2937;
            transition: all 0.3s ease;
        }

        .set-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: scale(1.05);
        }
        
        .save-match-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .save-match-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        .delete-match-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .delete-match-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .offline {
            background: linear-gradient(135deg, #ef4444, #dc2626) !important;
        }

        .connecting {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
                margin-bottom: 30px;
            }

            .match-cell {
                width: 75px;
                font-size: 10px;
                padding: 6px !important;
            }

            .export-btn {
                padding: 14px 20px;
                margin: 8px 4px;
                font-size: 0.8em;
            }

            .tournament-input {
                flex-direction: column;
            }

            .tournament-input input {
                min-width: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="status-bar" id="statusBar">
        <div class="loading"></div> Inizializzazione database cloud...
    </div>

    <div class="container">
        <div class="main-content">
            <h1>üéæ Torneo Tennis Cloud ‚òÅÔ∏è</h1>
            
            <!-- Setup iniziale -->
            <div class="setup-section" id="setupSection">
                <h2>üöÄ Configura il tuo Torneo</h2>
                <p>Crea o unisciti a un torneo. I dati si salveranno automaticamente nel cloud!</p>
                
                <div class="tournament-input">
                    <input type="text" id="tournamentName" placeholder="Nome torneo (es: TennisClub2025)" 
                           value="TorneoTennis2025" maxlength="50">
                    <button onclick="createTournament()">üèÜ Crea Torneo</button>
                    <button onclick="joinTournament()">üë• Unisciti</button>
                </div>

                <div class="info-panel">
                    <h3>üí° Come funziona:</h3>
                    <ul>
                        <li><strong>Crea Torneo:</strong> Inizia un nuovo torneo con il nome scelto</li>
                        <li><strong>Unisciti:</strong> Entra in un torneo esistente usando lo stesso nome</li>
                        <li><strong>Salvataggio automatico:</strong> Ogni risultato viene salvato istantaneamente</li>
                        <li><strong>Condivisione:</strong> Tutti con lo stesso nome torneo vedranno i dati aggiornati</li>
                    </ul>
                </div>
            </div>

            <!-- Torneo attivo -->
            <div class="tournament-active" id="tournamentActive" style="display: none;">
                <h3>üèÜ Torneo Attivo: <span id="activeTournamentName"></span></h3>
                <p>Database sincronizzato ‚úÖ | <button onclick="leaveTournament()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Cambia Torneo</button></p>
            </div>
            
            <div class="points-legend" id="gameContent" style="display: none;">
                <h3>üìä Sistema di Punteggio</h3>
                <ul>
                    <li><strong>3 punti</strong> - Vittoria 2-0 (set)</li>
                    <li><strong>2 punti</strong> - Vittoria 2-1 (set)</li>
                    <li><strong>1 punto</strong> - Sconfitta 2-1 (set)</li>
                    <li><strong>0 punti</strong> - Sconfitta 2-0 (set)</li>
                </ul>
                <p><em>üí° Clicca su una cella della tabella risultati per inserire il punteggio dettagliato di ogni set.</em></p>
            </div>
            
            <div class="stats" id="tournamentStats" style="display: none;">
                <div class="stat-item">
                    <div>Partite Giocate</div>
                    <div id="matchesPlayed">0</div>
                </div>
                <div class="stat-item">
                    <div>Partite Totali</div>
                    <div id="totalMatches">66</div>
                </div>
                <div class="stat-item">
                    <div>Completamento</div>
                    <div id="completionPercentage">0%</div>
                </div>
                <div class="stat-item">
                    <div>Set Giocati</div>
                    <div id="totalSets">0</div>
                </div>
            </div>
            
            <div class="section" id="rankingSection" style="display: none;">
                <h2>üèÜ Classifica Generale</h2>
                <table class="ranking-table" id="rankingTable">
                    <thead>
                        <tr>
                            <th>Pos.</th>
                            <th>Giocatore</th>
                            <th>Punti</th>
                            <th>Partite</th>
                            <th>V-S</th>
                            <th>Set V-P</th>
                            <th>Diff. Set</th>
                            <th>Games V-P</th>
                            <th>Diff. Games</th>
                            <th>Media</th>
                        </tr>
                    </thead>
                    <tbody id="rankingBody">
                    </tbody>
                </table>
            </div>
            
            <div class="section" id="resultsSection" style="display: none;">
                <h2>üìã Tabella Risultati</h2>
                <p><em>üí° Clicca su una cella per inserire il risultato dettagliato del match</em></p>
                <div style="overflow-x: auto;">
                    <table id="resultsTable">
                        <thead id="resultsHeader">
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="section" id="exportSection" style="display: none;">
                <button class="export-btn" onclick="exportToCSV()">üìä Esporta Classifica</button>
                <button class="export-btn" onclick="exportResultsToCSV()">üìã Esporta Risultati</button>
                <button class="export-btn" onclick="exportDetailedResults()">üìà Esporta Dettagliati</button>
                <button class="export-btn reset-btn" onclick="resetTournament()">üîÑ Reset Torneo</button>
            </div>
        </div>
    </div>

    <!-- Modal per inserimento risultato -->
    <div id="matchModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Inserisci Risultato Match</h2>
            <div class="match-form" id="matchForm">
                <div id="setsContainer"></div>
                <div>
                    <button class="save-match-btn" onclick="saveMatch()">üíæ Salva Risultato</button>
                    <button class="delete-match-btn" onclick="deleteMatch()">üóëÔ∏è Elimina Risultato</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üî• CONFIGURAZIONE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDemoKey-ReplaceWithYourKey",
            authDomain: "torneo-tennis-demo.firebaseapp.com",
            databaseURL: "https://torneo-tennis-demo-default-rtdb.firebaseio.com/",
            projectId: "torneo-tennis-demo",
            storageBucket: "torneo-tennis-demo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456789"
        };

        // üöÄ SISTEMA SIMULAZIONE DATABASE (per demo)
        let mockDatabase = {};
        let currentTournament = '';
        let isConnected = false;
        let players = [];
        let matches = {};
        let playerStats = {};
        let currentMatchKey = '';

        // Simula Firebase per demo
        const db = {
            ref: (path) => ({
                set: (data) => {
                    const keys = path.split('/');
                    let current = mockDatabase;
                    for (let i = 0; i < keys.length - 1; i++) {
                        if (!current[keys[i]]) current[keys[i]] = {};
                        current = current[keys[i]];
                    }
                    current[keys[keys.length - 1]] = data;
                    updateStatus('‚òÅÔ∏è Salvato nel cloud');
                    return Promise.resolve();
                },
                once: (event) => {
                    const keys = path.split('/');
                    let current = mockDatabase;
                    for (let key of keys) {
                        if (!current[key]) return Promise.resolve({ val: () => null });
                        current = current[key];
                    }
                    return Promise.resolve({ val: () => current });
                },
                on: (event, callback) => {
                    // Simula listener real-time
                    const keys = path.split('/');
                    let current = mockDatabase;
                    for (let key of keys) {
                        if (!current[key]) current[key] = {};
                        current = current[key];
                    }
                    callback({ val: () => current });
                }
            })
        };

        // üìä GIOCATORI PREDEFINITI
        const defaultPlayers = [
            'Alessandro Rossi', 'Marco Bianchi', 'Giuseppe Verdi', 'Francesco Romano',
            'Andrea Colombo', 'Matteo Ferrari', 'Lorenzo Marino', 'Davide Ricci',
            'Simone Greco', 'Federico Costa', 'Gabriele Conti', 'Riccardo Villa'
        ];

        // üéØ INIZIALIZZAZIONE
        function initApp() {
            try {
                updateStatus('üîó Connessione al database...');
                
                // Simula connessione
                setTimeout(() => {
                    isConnected = true;
                    updateStatus('‚úÖ Database connesso - Pronto per giocare!');
                    document.getElementById('statusBar').classList.remove('connecting');
                }, 2000);

            } catch (error) {
                console.error('Errore inizializzazione:', error);
                updateStatus('‚ùå Errore connessione - Modalit√† offline');
                document.getElementById('statusBar').classList.add('offline');
            }
        }

        // üì± UPDATE STATUS
        function updateStatus(message) {
            const statusBar = document.getElementById('statusBar');
            statusBar.innerHTML = message;
            
            if (message.includes('‚úÖ')) {
                statusBar.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            } else if (message.includes('‚ùå')) {
                statusBar.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            } else if (message.includes('‚òÅÔ∏è')) {
                statusBar.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
            }

            // Auto-hide dopo 5 secondi se √® un messaggio di salvataggio
            if (message.includes('Salvato') || message.includes('vince')) {
                setTimeout(() => {
                    if (isConnected) {
                        updateStatus('‚úÖ Database connesso - Pronto per giocare!');
                    }
                }, 5000);
            }
        }

        // üèÜ CREA TORNEO
        async function createTournament() {
            const tournamentName = document.getElementById('tournamentName').value.trim();
            
            if (!tournamentName) {
                alert('‚ö†Ô∏è Inserisci un nome per il torneo');
                return;
            }
            
            if (!isConnected) {
                alert('‚ùå Database non connesso. Riprova tra qualche secondo.');
                return;
            }

            try {
                updateStatus('üèóÔ∏è Creazione torneo in corso...');
                currentTournament = tournamentName;
                
                // Inizializza dati del torneo
                players = [...defaultPlayers];
                initializePlayerStats();
                initializeMatches();
                
                // Salva nel database
                await db.ref(`tournaments/${tournamentName}`).set({
                    players: players,
                    matches: matches,
                    playerStats: playerStats,
                    created: new Date().toISOString(),
                    lastUpdate: new Date().toISOString()
                });
                
                showTournament();
                updateStatus(`üèÜ Torneo "${tournamentName}" creato con successo!`);
                
            } catch (error) {
                console.error('Errore creazione torneo:', error);
                updateStatus('‚ùå Errore durante la creazione del torneo');
            }
        }

        // üë• UNISCITI AL TORNEO
        async function joinTournament() {
            const tournamentName = document.getElementById('tournamentName').value.trim();
            
            if (!tournamentName) {
                alert('‚ö†Ô∏è Inserisci il nome del torneo');
                return;
            }
            
            if (!isConnected) {
                alert('‚ùå Database non connesso. Riprova tra qualche secondo.');
                return;
            }

            try {
                updateStatus('üîç Ricerca torneo...');
                
                const snapshot = await db.ref(`tournaments/${tournamentName}`).once('value');
                const tournamentData = snapshot.val();
                
                if (!tournamentData) {
                    alert(`‚ùå Torneo "${tournamentName}" non trovato.\n\nClicca "Crea Torneo" per crearlo.`);
                    updateStatus('‚ùå Torneo non trovato');
                    return;
                }
                
                // Carica dati esistenti
                currentTournament = tournamentName;
                players = tournamentData.players || [...defaultPlayers];
                matches = tournamentData.matches || {};
                playerStats = tournamentData.playerStats || {};
                
                // Se non ci sono statistiche, inizializzale
                if (Object.keys(playerStats).length === 0) {
                    initializePlayerStats();
                }
                
                // Se non ci sono match, inizializzali
                if (Object.keys(matches).length === 0) {
                    initializeMatches();
                }
                
                showTournament();
                setupRealtimeSync();
                updateStatus(`üë• Connesso al torneo "${tournamentName}"!`);
                
            } catch (error) {
                console.error('Errore unione torneo:', error);
                updateStatus('‚ùå Errore durante l\'accesso al torneo');
            }
        }

        // üì° SINCRONIZZAZIONE REAL-TIME
        function setupRealtimeSync() {
            // Ascolta cambiamenti ai match
            db.ref(`tournaments/${currentTournament}/matches`).on('value', (snapshot) => {
                const newMatches = snapshot.val();
                if (newMatches && JSON.stringify(newMatches) !== JSON.stringify(matches)) {
                    matches = newMatches;
                    updateAllDisplays();
                    updateStatus('üîÑ Dati aggiornati automaticamente');
                }
            });
            
            // Ascolta cambiamenti alle statistiche
            db.ref(`tournaments/${currentTournament}/playerStats`).on('value', (snapshot) => {
                const newStats = snapshot.val();
                if (newStats && JSON.stringify(newStats) !== JSON.stringify(playerStats)) {
                    playerStats = newStats;
                    updateRanking();
                    updateStats();
                }
            });
        }

        // üèÉ‚Äç‚ôÇÔ∏è ESCI DAL TORNEO
        function leaveTournament() {
            if (confirm('Vuoi davvero cambiare torneo?')) {
                currentTournament = '';
                document.getElementById('setupSection').style.display = 'block';
                document.getElementById('tournamentActive').style.display = 'none';
                hideGameContent();
                updateStatus('üëã Disconnesso dal torneo');
            }
        }

        // üëÅÔ∏è MOSTRA CONTENUTO TORNEO
        function showTournament() {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('tournamentActive').style.display = 'block';
            document.getElementById('activeTournamentName').textContent = currentTournament;
            
            // Mostra sezioni del gioco
            document.getElementById('gameContent').style.display = 'block';
            document.getElementById('tournamentStats').style.display = 'grid';
            document.getElementById('rankingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('exportSection').style.display = 'block';
            
            // Crea tabelle e aggiorna tutto
            createResultsTable();
            updateRanking();
            updateStats();
            updateAllDisplays();
        }

        // üôà NASCONDI CONTENUTO GIOCO
        function hideGameContent() {
            document.getElementById('gameContent').style.display = 'none';
            document.getElementById('tournamentStats').style.display = 'none';
            document.getElementById('rankingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('exportSection').style.display = 'none';
        }

        // üìä INIZIALIZZA STATISTICHE GIOCATORI
        function initializePlayerStats() {
            playerStats = {};
            players.forEach(player => {
                playerStats[player] = {
                    points: 0,
                    matches: 0,
                    wins: 0,
                    losses: 0,
                    setsWon: 0,
                    setsLost: 0,
                    gamesWon: 0,
                    gamesLost: 0
                };
            });
        }

        // üéæ INIZIALIZZA MATCH
        function initializeMatches() {
            matches = {};
            for (let i = 0; i < players.length; i++) {
                for (let j = 0; j < players.length; j++) {
                    if (i !== j) {
                        const key = `${players[i]}vs${players[j]}`;
                        matches[key] = {
                            player1: players[i],
                            player2: players[j],
                            sets: [],
                            player1Sets: 0,
                            player2Sets: 0,
                            completed: false
                        };
                    }
                }
            }
        }

        // üìã CREA TABELLA RISULTATI
        function createResultsTable() {
            const header = document.getElementById('resultsHeader');
            const body = document.getElementById('resultsBody');
            
            // Crea l'header
            let headerRow = '<tr><th style="width: 120px;">Giocatori</th>';
            players.forEach(player => {
                const displayName = player.length > 10 ? player.substring(0, 8) + '...' : player;
                headerRow += `<th style="min-width: 90px; font-size: 10px;" title="${player}">${displayName}</th>`;
            });
            headerRow += '</tr>';
            header.innerHTML = headerRow;
            
            // Crea le righe
            let bodyHTML = '';
            players.forEach((player1, i) => {
                const displayName1 = player1.length > 10 ? player1.substring(0, 8) + '...' : player1;
                let row = `<tr><td class="player-cell" title="${player1}">${displayName1}</td>`;
                players.forEach((player2, j) => {
                    if (i === j) {
                        row += '<td class="match-diagonal">‚Äî</td>';
                    } else {
                        const key = `${player1}vs${player2}`;
                        const cellId = `cell-${i}-${j}`;
                        row += `<td id="${cellId}" class="match-cell" 
                               onclick="openMatchModal('${key}', '${player1}', '${player2}')"
                               title="Match: ${player1} vs ${player2}">
                            <div class="match-details" id="summary-${key}">
                                <div style="color: #9ca3af; font-style: italic;">vs</div>
                            </div>
                        </td>`;
                    }
                });
                row += '</tr>';
                bodyHTML += row;
            });
            body.innerHTML = bodyHTML;
        }

        // üéØ APRI MODAL MATCH
        function openMatchModal(key, player1, player2) {
            if (!currentTournament) {
                alert('‚ö†Ô∏è Unisciti prima a un torneo!');
                return;
            }
            
            currentMatchKey = key;
            const modal = document.getElementById('matchModal');
            const title = document.getElementById('modalTitle');
            const container = document.getElementById('setsContainer');
            
            title.textContent = `üéæ ${player1} vs ${player2}`;
            
            const match = matches[key];
            if (!match) {
                console.error('Match non trovato:', key);
                return;
            }
            
            // Crea form per i set
            let setsHTML = '';
            for (let i = 0; i < 3; i++) {
                const set = match.sets[i] || { player1Games: '', player2Games: '' };
                const setNum = i + 1;
                
                setsHTML += `
                    <div class="set-form">
                        <label>Set ${setNum}:</label>
                        <span>${player1.length > 12 ? player1.substring(0, 10) + '...' : player1}</span>
                        <input type="number" id="p1-set${setNum}" class="set-input" min="0" max="7" 
                               value="${set.player1Games}" placeholder="0">
                        <span>-</span>
                        <input type="number" id="p2-set${setNum}" class="set-input" min="0" max="7" 
                               value="${set.player2Games}" placeholder="0">
                        <span>${player2.length > 12 ? player2.substring(0, 10) + '...' : player2}</span>
                    </div>
                `;
            }
            
            container.innerHTML = setsHTML;
            modal.style.display = 'block';
            
            setTimeout(() => {
                const firstInput = document.getElementById('p1-set1');
                if (firstInput) firstInput.focus();
            }, 200);
        }

        // ‚ùå CHIUDI MODAL
        function closeModal() {
            document.getElementById('matchModal').style.display = 'none';
            currentMatchKey = '';
        }

        // ‚úÖ VALIDA PUNTEGGIO SET
        function isValidSetScore(games1, games2) {
            if (games1 < 0 || games2 < 0 || !Number.isInteger(games1) || !Number.isInteger(games2)) {
                return false;
            }
            
            // Set normale: 6-4, 6-3, 6-2, 6-1, 6-0
            if (games1 === 6 && games2 <= 4) return true;
            if (games2 === 6 && games1 <= 4) return true;
            
            // Set con vantaggio: 7-5
            if (games1 === 7 && games2 === 5) return true;
            if (games2 === 7 && games1 === 5) return true;
            
            // Tie-break: 7-6
            if (games1 === 7 && games2 === 6) return true;
            if (games2 === 7 && games1 === 6) return true;
            
            return false;
        }

        // üíæ SALVA MATCH
        async function saveMatch() {
            if (!currentMatchKey || !currentTournament) {
                alert('‚ùå Errore: torneo non selezionato');
                return;
            }
            
            const match = matches[currentMatchKey];
            if (!match) {
                alert('‚ùå Errore: match non trovato');
                return;
            }
            
            const sets = [];
            let player1SetsWon = 0;
            let player2SetsWon = 0;
            
            // Leggi risultati dei set
            for (let i = 1; i <= 3; i++) {
                const p1Input = document.getElementById(`p1-set${i}`);
                const p2Input = document.getElementById(`p2-set${i}`);
                
                if (!p1Input || !p2Input) continue;
                
                const p1Games = parseInt(p1Input.value);
                const p2Games = parseInt(p2Input.value);
                
                if (!isNaN(p1Games) && !isNaN(p2Games) && p1Input.value !== '' && p2Input.value !== '') {
                    if (!isValidSetScore(p1Games, p2Games)) {
                        alert(`‚ùå Set ${i}: Punteggio non valido (${p1Games}-${p2Games}).\n\nEsempi validi:\n‚Ä¢ 6-4, 6-3, 6-2, 6-1, 6-0\n‚Ä¢ 7-5 (vantaggio)\n‚Ä¢ 7-6 (tie-break)`);
                        p1Input.focus();
                        return;
                    }
                    
                    sets.push({
                        player1Games: p1Games,
                        player2Games: p2Games
                    });
                    
                    if (p1Games > p2Games) {
                        player1SetsWon++;
                    } else {
                        player2SetsWon++;
                    }
                } else if (p1Input.value !== '' || p2Input.value !== '') {
                    alert(`‚ùå Set ${i}: Inserisci entrambi i punteggi o lascia vuoto.`);
                    return;
                }
            }
            
            if (sets.length === 0) {
                alert('‚ö†Ô∏è Inserisci almeno un set valido per salvare il match.');
                return;
            }
            
            if (player1SetsWon < 2 && player2SetsWon < 2) {
                alert('‚ö†Ô∏è Il match deve essere completato: un giocatore deve vincere almeno 2 set su 3.');
                return;
            }
            
            try {
                updateStatus('üíæ Salvataggio in corso...');
                
                // Aggiorna match
                match.sets = sets;
                match.player1Sets = player1SetsWon;
                match.player2Sets = player2SetsWon;
                match.completed = true;
                
                // Ricalcola punti
                calculatePoints();
                
                // Salva nel database
                await db.ref(`tournaments/${currentTournament}`).set({
                    players: players,
                    matches: matches,
                    playerStats: playerStats,
                    lastUpdate: new Date().toISOString()
                });
                
                // Aggiorna visualizzazione
                updateMatchDisplay(currentMatchKey);
                updateRanking();
                updateStats();
                
                closeModal();
                
                const winner = player1SetsWon > player2SetsWon ? match.player1 : match.player2;
                updateStatus(`üèÜ ${winner} vince ${player1SetsWon}-${player2SetsWon}`);
                
            } catch (error) {
                console.error('Errore salvataggio:', error);
                updateStatus('‚ùå Errore durante il salvataggio');
            }
        }

        // üóëÔ∏è ELIMINA MATCH
        async function deleteMatch() {
            if (confirm('Sei sicuro di voler eliminare questo risultato?')) {
                try {
                    const match = matches[currentMatchKey];
                    if (match) {
                        match.sets = [];
                        match.player1Sets = 0;
                        match.player2Sets = 0;
                        match.completed = false;
                        
                        calculatePoints();
                        
                        await db.ref(`tournaments/${currentTournament}`).set({
                            players: players,
                            matches: matches,
                            playerStats: playerStats,
                            lastUpdate: new Date().toISOString()
                        });
                        
                        updateMatchDisplay(currentMatchKey);
                        updateRanking();
                        updateStats();
                        updateStatus('üóëÔ∏è Risultato eliminato');
                    }
                } catch (error) {
                    console.error('Errore eliminazione:', error);
                    updateStatus('‚ùå Errore durante l\'eliminazione');
                }
                
                closeModal();
            }
        }

        // üéØ AGGIORNA VISUALIZZAZIONE MATCH
        function updateMatchDisplay(key) {
            const match = matches[key];
            const summaryElement = document.getElementById(`summary-${key}`);
            
            if (!summaryElement || !match) return;
            
            if (match.completed && match.sets.length > 0) {
                let setsDisplay = '';
                match.sets.forEach((set, index) => {
                    if (index > 0) setsDisplay += ' ';
                    setsDisplay += `${set.player1Games}-${set.player2Games}`;
                });
                
                const result = `${match.player1Sets}-${match.player2Sets}`;
                summaryElement.innerHTML = `
                    <div class="match-result">${result}</div>
                    <div class="set-details">${setsDisplay}</div>
                `;
                summaryElement.parentElement.classList.add('completed-match');
            } else {
                summaryElement.innerHTML = '<div style="color: #9ca3af; font-style: italic;">vs</div>';
                summaryElement.parentElement.classList.remove('completed-match');
            }
        }

        // üßÆ CALCOLA PUNTI
        function calculatePoints() {
            initializePlayerStats();
            
            Object.values(matches).forEach(match => {
                if (match.completed && match.sets.length > 0) {
                    const player1 = match.player1;
                    const player2 = match.player2;
                    const p1Sets = match.player1Sets;
                    const p2Sets = match.player2Sets;
                    
                    playerStats[player1].matches++;
                    playerStats[player2].matches++;
                    playerStats[player1].setsWon += p1Sets;
                    playerStats[player1].setsLost += p2Sets;
                    playerStats[player2].setsWon += p2Sets;
                    playerStats[player2].setsLost += p1Sets;
                    
                    let p1Games = 0, p2Games = 0;
                    match.sets.forEach(set => {
                        p1Games += set.player1Games;
                        p2Games += set.player2Games;
                    });
                    
                    playerStats[player1].gamesWon += p1Games;
                    playerStats[player1].gamesLost += p2Games;
                    playerStats[player2].gamesWon += p2Games;
                    playerStats[player2].gamesLost += p1Games;
                    
                    if (p1Sets > p2Sets) {
                        playerStats[player1].wins++;
                        playerStats[player2].losses++;
                        
                        if (p1Sets === 2 && p2Sets === 0) {
                            playerStats[player1].points += 3;
                        } else {
                            playerStats[player1].points += 2;
                            playerStats[player2].points += 1;
                        }
                    } else {
                        playerStats[player2].wins++;
                        playerStats[player1].losses++;
                        
                        if (p2Sets === 2 && p1Sets === 0) {
                            playerStats[player2].points += 3;
                        } else {
                            playerStats[player2].points += 2;
                            playerStats[player1].points += 1;
                        }
                    }
                }
            });
        }

        // üèÜ AGGIORNA CLASSIFICA
        function updateRanking() {
            const tbody = document.getElementById('rankingBody');
            if (!tbody) return;
            
            const sortedPlayers = players.slice().sort((a, b) => {
                const aStats = playerStats[a];
                const bStats = playerStats[b];
                
                if (bStats.points !== aStats.points) {
                    return bStats.points - aStats.points;
                }
                
                const aSetDiff = aStats.setsWon - aStats.setsLost;
                const bSetDiff = bStats.setsWon - bStats.setsLost;
                if (bSetDiff !== aSetDiff) {
                    return bSetDiff - aSetDiff;
                }
                
                const aGameDiff = aStats.gamesWon - aStats.gamesLost;
                const bGameDiff = bStats.gamesWon - bStats.gamesLost;
                if (bGameDiff !== aGameDiff) {
                    return bGameDiff - aGameDiff;
                }
                
                return bStats.gamesWon - aStats.gamesWon;
            });
            
            let html = '';
            sortedPlayers.forEach((player, index) => {
                const stats = playerStats[player];
                const setDiff = stats.setsWon - stats.setsLost;
                const gameDiff = stats.gamesWon - stats.gamesLost;
                const avgPoints = stats.matches > 0 ? (stats.points / stats.matches).toFixed(2) : '0.00';
                
                let rowClass = '';
                if (index === 0) rowClass = 'first-place';
                else if (index === 1) rowClass = 'second-place';
                else if (index === 2) rowClass = 'third-place';
                
                const playerName = player.length > 12 ? player.substring(0, 10) + '...' : player;
                
                html += `
                    <tr class="${rowClass}">
                        <td><strong>${index + 1}</strong></td>
                        <td title="${player}"><strong>${playerName}</strong></td>
                        <td><strong>${stats.points}</strong></td>
                        <td>${stats.matches}</td>
                        <td>${stats.wins}-${stats.losses}</td>
                        <td>${stats.setsWon}-${stats.setsLost}</td>
                        <td>${setDiff > 0 ? '+' : ''}${setDiff}</td>
                        <td>${stats.gamesWon}-${stats.gamesLost}</td>
                        <td>${gameDiff > 0 ? '+' : ''}${gameDiff}</td>
                        <td>${avgPoints}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // üìä AGGIORNA STATISTICHE
        function updateStats() {
            const totalMatches = (players.length * (players.length - 1)) / 2;
            let playedMatches = 0;
            let totalSets = 0;
            
            const countedPairs = new Set();
            
            Object.values(matches).forEach(match => {
                if (match.completed) {
                    const pair1 = `${match.player1}-${match.player2}`;
                    const pair2 = `${match.player2}-${match.player1}`;
                    
                    if (!countedPairs.has(pair1) && !countedPairs.has(pair2)) {
                        playedMatches++;
                        totalSets += match.sets.length;
                        countedPairs.add(pair1);
                    }
                }
            });
            
            const completionPercentage = totalMatches > 0 ? Math.round((playedMatches / totalMatches) * 100) : 0;
            
            document.getElementById('matchesPlayed').textContent = playedMatches;
            document.getElementById('totalMatches').textContent = totalMatches;
            document.getElementById('completionPercentage').textContent = `${completionPercentage}%`;
            document.getElementById('totalSets').textContent = totalSets;
        }

        // üîÑ AGGIORNA TUTTE LE VISUALIZZAZIONI
        function updateAllDisplays() {
            Object.keys(matches).forEach(key => {
                updateMatchDisplay(key);
            });
            calculatePoints();
            updateRanking();
            updateStats();
        }

        // üì§ EXPORT FUNZIONI
        function exportToCSV() {
            // ... stessa logica di prima per export CSV
            alert('üí° Export CSV - Implementazione completa nel sistema reale');
        }

        function exportResultsToCSV() {
            alert('üí° Export risultati - Implementazione completa nel sistema reale');
        }

        function exportDetailedResults() {
            alert('üí° Export dettagliati - Implementazione completa nel sistema reale');
        }

        // üîÑ RESET TORNEO
        async function resetTournament() {
            if (confirm('‚ö†Ô∏è Sei sicuro di voler resettare tutto il torneo?\n\nTutti i risultati andranno persi definitivamente.')) {
                try {
                    updateStatus('üîÑ Reset in corso...');
                    
                    initializePlayerStats();
                    initializeMatches();
                    
                    await db.ref(`tournaments/${currentTournament}`).set({
                        players: players,
                        matches: matches,
                        playerStats: playerStats,
                        created: new Date().toISOString(),
                        lastUpdate: new Date().toISOString()
                    });
                    
                    updateAllDisplays();
                    updateStatus('üîÑ Torneo resettato con successo!');
                    
                } catch (error) {
                    console.error('Errore reset:', error);
                    updateStatus('‚ùå Errore durante il reset');
                }
            }
        }

        // üéÆ EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            
            // Event listeners modal
            const closeBtn = document.querySelector('.close');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
            }
            
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('matchModal');
                if (event.target === modal) {
                    closeModal();
                }
            });
            
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modal = document.getElementById('matchModal');
                    if (modal && modal.style.display === 'block') {
                        closeModal();
                    }
                }
                
                if (event.key === 'Enter' && event.target.classList.contains('set-input')) {
                    const inputs = document.querySelectorAll('.set-input');
                    const currentIndex = Array.from(inputs).indexOf(event.target);
                    if (currentIndex < inputs.length - 1) {
                        inputs[currentIndex + 1].focus();
                    } else {
                        saveMatch();
                    }
                    event.preventDefault();
                }
            });

            // Auto-focus su input torneo
            document.getElementById('tournamentName').focus();
        });
    </script>
</body>
</html>
